
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Working with four dimensional images, masks and functions &#8212; Practice and theory of brain imaging</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Reshaping, 4D to 2D" href="reshape_and_4d.html" />
    <link rel="prev" title="Boolean indexing with more than one dimension" href="boolean_indexing_nd.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/reggie.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Practice and theory of brain imaging</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Practice and theory of brain imaging
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  The neuroimaging problem
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="the_problem.html">
   The problem and the plan
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  The tools
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="to_code.html">
   Ode to code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="surviving_computers.html">
   Surviving the computer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="the_software.html">
   Our tools
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="using_jupyter.html">
   Using Jupyter notebooks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="more_on_jupyter.html">
   More on the Jupyter notebook
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="brisk_python.html">
   Brisk introduction to Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="installation.html">
   Installing on your computer
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Images and code and images
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="pathlib.html">
   Using the
   <code class="docutils literal notranslate">
    <span class="pre">
     pathlib
    </span>
   </code>
   module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="what_is_an_image.html">
   What is an image?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_intro.html">
   Introduction to Numpy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="boolean_arrays.html">
   Boolean arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="reshape_and_2d.html">
   Two-dimensions, reshaping
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="arrays_and_images.html">
   Arrays as images, images as arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="arrays_3d.html">
   Three-dimensional arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="images_3d.html">
   Three-dimensional images, NIfTI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="reshape_and_3d.html">
   Reshaping and three-dimensional arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="boolean_indexing.html">
   Indexing with Boolean arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="boolean_indexing_nd.html">
   Boolean indexing with more than one dimension
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Working with four dimensional images, masks and functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="reshape_and_4d.html">
   Reshaping, 4D to 2D
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="voxels_by_time.html">
   Voxels and time
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Working reproducibly
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="on_modules.html">
   Modules and scripts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sys_path.html">
   Where does Python look for modules?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assert.html">
   Using
   <code class="docutils literal notranslate">
    <span class="pre">
     assert
    </span>
   </code>
   for testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="coding_style.html">
   Python coding style
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="docstrings.html">
   Docstrings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="module_directories.html">
   Module directories
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="on_testing.html">
   On testing
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Detecting activation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="voxel_time_courses.html">
   Correlating with voxel time courses
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="on_convolution.html">
   Convolution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="convolution_background.html">
   Convolving with the hemodyamic response function
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="on_regression.html">
   Introducing regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="regress_one_voxel.html">
   Regression for a single voxel
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="regression_notation.html">
   Notation for regression models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="glm_intro.html">
   Introduction to the general linear model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mean_test_example.html">
   A worked example of the general linear model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="model_one_voxel.html">
   Modeling a single voxel
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="multi_multiply.html">
   Estimation for many voxels at the same time
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hypothesis_tests.html">
   Hypothesis testing with the general linear model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="test_one_voxel.html">
   Testing a single voxel
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="non_tr_onsets.html">
   Using onsets that do not start on a TR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="whole_image_statistics.html">
   Whole-brain t tests and p values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="bonferroni_correction.html">
   Notes on the Bonferroni threshold
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Spatial processing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="slice_timing.html">
   Slice timing correction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="optimizing_space.html">
   Calculating transformations between images
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="diagonal_zooms.html">
   Encoding zooms (scaling) with a diagonal matrix
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nibabel_affines.html">
   The
   <code class="docutils literal notranslate">
    <span class="pre">
     nibabel.affines
    </span>
   </code>
   module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nibabel_apply_affine.html">
   Applying coordinate transforms with
   <code class="docutils literal notranslate">
    <span class="pre">
     nibabel.affines.apply_affine
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="map_coordinates.html">
   General resampling between images with
   <code class="docutils literal notranslate">
    <span class="pre">
     scipy.ndimage.map_coordinates
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="image_header_and_affine.html">
   The image header and affine
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="images_and_affines.html">
   Images and affines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rotation_2d_3d.html">
   Rotations and rotation matrices
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="resampling_with_ndimage.html">
   Resampling with
   <code class="docutils literal notranslate">
    <span class="pre">
     scipy.ndimage
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dipy_registration.html">
   Registration with dipy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="anterior_cingulate.html">
   Anterior cingulate
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Notes on arrays and plots
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="methods_vs_functions.html">
   Methods vs functions in NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="allclose.html">
   Testing for near equality with “allclose”
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="arange.html">
   NumPy arange
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_logical.html">
   Logical operations on Boolean arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dot_outer.html">
   Vector and matrix dot products, “np.outer”
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="newaxis.html">
   Adding length 1 dimensions with newaxis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="array_reductions.html">
   Array reduction operations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_random.html">
   Numpy random number generators
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="subtract_means.html">
   Subtracting the mean from columns or rows
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="plot_lines.html">
   Plotting lines in matplotlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="subplots.html">
   Subplots and axes in matplotlib
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/nipraxis/textbook/main?urlpath=tree/intro_to_4d.Rmd"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://hub.nipraxis.org/hub/user-redirect/git-pull?repo=https%3A//github.com/nipraxis/textbook&urlpath=tree/textbook/intro_to_4d.Rmd&branch=main"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on JupyterHub"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_jupyterhub.svg">
  </span>
<span class="headerbtn__text-container">JupyterHub</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/nipraxis/textbook/blob/main/intro_to_4d.Rmd"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Fnipraxis%2Ftextbook%2Fblob%2Fmain%2Fintro_to_4d.Rmd"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Deepnote"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_deepnote.svg">
  </span>
<span class="headerbtn__text-container">Deepnote</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/nipraxis/textbook"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/nipraxis/textbook/issues/new?title=Issue%20on%20page%20%2Fintro_to_4d.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/intro_to_4d.Rmd"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.Rmd</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#loading-data-with-nibabel">
   Loading data with Nibabel
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#saving-memory">
   Saving memory
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#four-dimensional-arrays-space-time">
   Four dimensional arrays: space + time
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-voxel-time-course">
   The voxel time course
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#numpy-operations-work-on-the-whole-array-by-default">
   Numpy operations work on the whole array by default
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Working with four dimensional images, masks and functions</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#loading-data-with-nibabel">
   Loading data with Nibabel
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#saving-memory">
   Saving memory
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#four-dimensional-arrays-space-time">
   Four dimensional arrays: space + time
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-voxel-time-course">
   The voxel time course
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#numpy-operations-work-on-the-whole-array-by-default">
   Numpy operations work on the whole array by default
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="working-with-four-dimensional-images-masks-and-functions">
<h1>Working with four dimensional images, masks and functions<a class="headerlink" href="#working-with-four-dimensional-images-masks-and-functions" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#: Our usual imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  <span class="c1"># the Python array package</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  <span class="c1"># the Python plotting package</span>
</pre></div>
</div>
</div>
</div>
<section id="loading-data-with-nibabel">
<h2>Loading data with Nibabel<a class="headerlink" href="#loading-data-with-nibabel" title="Permalink to this headline">#</a></h2>
<p>Nibabel allows us to <code class="docutils literal notranslate"><span class="pre">load</span></code> images. First we need to <code class="docutils literal notranslate"><span class="pre">import</span></code> the nibabel
library:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
</pre></div>
</div>
</div>
</div>
<p>We are going to load the image with filename <code class="docutils literal notranslate"><span class="pre">ds114_sub009_t2r1.nii</span></code>.</p>
<p>First we use the <code class="docutils literal notranslate"><span class="pre">nipraxis</span></code> utility to find the file on the web and download
it to the computer we are working on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the utility.</span>
<span class="kn">import</span> <span class="nn">nipraxis</span>
<span class="c1"># Use the fetch_file function to find the file and download</span>
<span class="c1"># it to this computer.</span>
<span class="n">image_fname</span> <span class="o">=</span> <span class="n">nipraxis</span><span class="o">.</span><span class="n">fetch_file</span><span class="p">(</span><span class="s1">&#39;ds114_sub009_t2r1.nii&#39;</span><span class="p">)</span>
<span class="c1"># Show the filename of the downloaded file.</span>
<span class="n">image_fname</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading file &#39;ds114_sub009_t2r1.nii&#39; from &#39;https://raw.githubusercontent.com/nipraxis/nipraxis-data/0.4/ds114_sub009_t2r1.nii&#39; to &#39;/home/runner/.cache/nipraxis/0.4&#39;.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/home/runner/.cache/nipraxis/0.4/ds114_sub009_t2r1.nii&#39;
</pre></div>
</div>
</div>
</div>
<p>Next we <code class="docutils literal notranslate"><span class="pre">load</span></code> the image, to give me an “image” object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">image_fname</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>nibabel.nifti1.Nifti1Image
</pre></div>
</div>
</div>
</div>
<p>You can explore the image object with <code class="docutils literal notranslate"><span class="pre">img.</span></code> followed by the Tab key at the
Jupyter / IPython prompt.</p>
</section>
<section id="saving-memory">
<h2>Saving memory<a class="headerlink" href="#saving-memory" title="Permalink to this headline">#</a></h2>
<p>Because images can have large arrays, Nibabel does not load the image array
when you <code class="docutils literal notranslate"><span class="pre">load</span></code> the image, in order to save time and memory. The best way to
get the image array data is with the <code class="docutils literal notranslate"><span class="pre">get_fdata()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>numpy.memmap
</pre></div>
</div>
</div>
</div>
<p>See <a class="reference external" href="https://nipy.org/nibabel/images_and_memory.html">Nibabel images and
memory</a> for more detail.</p>
</section>
<section id="four-dimensional-arrays-space-time">
<h2>Four dimensional arrays: space + time<a class="headerlink" href="#four-dimensional-arrays-space-time" title="Permalink to this headline">#</a></h2>
<p>The image we have just loaded is a four-dimensional image, with a
four-dimensional array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(64, 64, 30, 173)
</pre></div>
</div>
</div>
</div>
<p>The first three axes represent three dimensional space. The last axis
represents time. Here the last (time) axis has length 173. This means that,
for each of these 173 elements, there is one whole three dimensional image. We
often call the three-dimensional images <em>volumes</em>. So we could say that this
4D image contains 173 volumes.</p>
<p>We have previously been taking slices over the third axis of a
three-dimensional image. We can now take slices over the fourth axis of this
four-dimensional image:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A slice over the final (time) axis</span>
<span class="n">first_vol</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>This slice selects the first three-dimensional volume (3D image) from the 4D
array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">first_vol</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(64, 64, 30)
</pre></div>
</div>
</div>
</div>
<p>You can use the ellipsis <code class="docutils literal notranslate"><span class="pre">...</span></code> when slicing an array. The ellipsis is a
short cut for “everything on the previous axes”. For example, these two have
exactly the same meaning:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">first_vol</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># All rows, all columns, all planes, vol 0</span>
<span class="n">first_vol_again</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># The same thing, using the ellipsis</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">first_vol</span></code> is a 3D image just like the 3D images you have already seen:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A slice over the third axis (dimension).</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">first_vol</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">14</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7ffb45b5d760&gt;
</pre></div>
</div>
<img alt="_images/intro_to_4d_21_1.png" src="_images/intro_to_4d_21_1.png" />
</div>
</div>
</section>
<section id="the-voxel-time-course">
<h2>The voxel time course<a class="headerlink" href="#the-voxel-time-course" title="Permalink to this headline">#</a></h2>
<p>We can think of this 4D data as a series of 3D volumes.  That is the way we
have been thinking of the 4D data so far:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is slicing over the last (time) axis</span>
<span class="n">first_vol</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">first_vol</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(64, 64, 30)
</pre></div>
</div>
</div>
</div>
<p>We can also index over the first three axes.  The first three axes in this
array represent space.</p>
<ul class="simple">
<li><p>The first axis goes from right to left (0 index value means right, 63 means
left);</p></li>
<li><p>The second axis goes from back to front (0 index value means back, 63 means
front);</p></li>
<li><p>The third axes goes from bottom to top (0 means bottom, 29 means top).</p></li>
</ul>
<p>If you give me index values for these first three axes, you have given me a
<em>coordinate</em> in the first three axes of the array.</p>
<p>For example, you could give me an index tuple for the first three axes like
this: <code class="docutils literal notranslate"><span class="pre">(42,</span> <span class="pre">32,</span> <span class="pre">19)</span></code>.  The first index of 42 refers to a position towards
the left of the brain (&gt; 31).  The second index of 32 refers to a position
almost in the center front to back.  The last index of 19 refers to a position
a little further towards the top of the brain – in this image.</p>
<p>This coordinate therefore refers to a particular part of the image:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Where is this in the brain?</span>
<span class="c1"># Don&#39;t worry about this line, we come to that soon.</span>
<span class="n">mean_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Make a nice bright dot in the right place</span>
<span class="n">mean_data</span><span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mean_data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mean_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">19</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7ffb45a6cb20&gt;
</pre></div>
</div>
<img alt="_images/intro_to_4d_25_1.png" src="_images/intro_to_4d_25_1.png" />
</div>
</div>
<p>If we slice into the data array with these coordinates, we will get a vector,
with the image value at that position (43, 32, 19), for every point in time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is slicing over all three of the space axes</span>
<span class="n">voxel_time_course</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">voxel_time_course</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(173,)
</pre></div>
</div>
</div>
</div>
<p><img alt="" src="_images/volumes_and_voxel.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do a plot of these values.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">voxel_time_course</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Volume index&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Signal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Voxel time course&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/intro_to_4d_29_0.png" src="_images/intro_to_4d_29_0.png" />
</div>
</div>
<p>We could call this a “voxel time course”.</p>
</section>
<section id="numpy-operations-work-on-the-whole-array-by-default">
<h2>Numpy operations work on the whole array by default<a class="headerlink" href="#numpy-operations-work-on-the-whole-array-by-default" title="Permalink to this headline">#</a></h2>
<p>Numpy operations like <code class="docutils literal notranslate"><span class="pre">mean</span></code> and <code class="docutils literal notranslate"><span class="pre">min</span></code>, and <code class="docutils literal notranslate"><span class="pre">max</span></code> and <code class="docutils literal notranslate"><span class="pre">std</span></code> operate on the
whole numpy array by default, ignoring any array shape. For example, here is
the maximum value for the <strong>whole 4D array</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6793.0
</pre></div>
</div>
</div>
</div>
<p>This is exactly the same as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Maximum when flattening the array to 1 dimension</span>
<span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6793.0
</pre></div>
</div>
</div>
</div>
<p>You can ask Numpy to operate over particular axes instead of operating over
the whole array. For example, this will generate a 3D image, where each array
value is the mean over the 173 values at the corresponding 3D position (the
mean across time):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mean across the final (time) axis</span>
<span class="n">mean_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="c1"># Show the middle plane of this mean volume.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mean_vol</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">14</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7ffb45975730&gt;
</pre></div>
</div>
<img alt="_images/intro_to_4d_36_1.png" src="_images/intro_to_4d_36_1.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "nipraxis/textbook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="boolean_indexing_nd.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Boolean indexing with more than one dimension</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="reshape_and_4d.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Reshaping, 4D to 2D</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The nipraxis team<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>