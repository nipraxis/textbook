
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Images and affines &#8212; Practice and theory of brain imaging</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Rotations and rotation matrices" href="rotation_2d_3d.html" />
    <link rel="prev" title="The image header and affine" href="image_header_and_affine.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/reggie.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Practice and theory of brain imaging</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Practice and theory of brain imaging
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  The neuroimaging problem
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="the_problem.html">
   The problem and the plan
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  The tools
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="to_code.html">
   Ode to code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="surviving_computers.html">
   Surviving the computer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="the_software.html">
   Our tools
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="using_jupyter.html">
   Using Jupyter notebooks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="more_on_jupyter.html">
   More on the Jupyter notebook
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="brisk_python.html">
   Brisk introduction to Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="installation.html">
   Installing on your computer
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  Images and code and images
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="what_is_an_image.html">
   What is an image?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="arrays_and_images.html">
   Arrays as images, images as arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="slicing_with_booleans.html">
   Slicing with boolean vectors
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_logical.html">
   Logical operations on boolean arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="reshape_and_3d.html">
   Reshaping and three-dimensional arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="otsu_threshold.html">
   Otsu’s method for binarizing images
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_random.html">
   Random numbers with
   <code class="docutils literal notranslate">
    <span class="pre">
     np.random
    </span>
   </code>
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  Arrays and plots
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="methods_vs_functions.html">
   Methods vs functions in NumPy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="reshape_and_4d.html">
   Reshaping, 4D to 2D
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="allclose.html">
   Testing for near equality with “allclose”
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="arange.html">
   Numpy arange
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dot_outer.html">
   Vector and matrix dot products, “np.outer”
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="newaxis.html">
   Adding length 1 dimensions with newaxis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="subtract_means.html">
   Subtracting the mean from columns or rows
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="plot_lines.html">
   Plotting lines in matplotlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="subplots.html">
   Subplots and axes in matplotlib
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  Into the fourth dimension
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro_to_4d.html">
   Working with four dimensional images, masks and functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="voxels_by_time.html">
   Reshaping 4D images to 2D arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="voxel_time_courses.html">
   Voxel time courses
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  Coordinate systems and spatial transforms
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="diagonal_zooms.html">
   Encoding zooms (scaling) with a diagonal matrix
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nibabel_affines.html">
   The
   <code class="docutils literal notranslate">
    <span class="pre">
     nibabel.affines
    </span>
   </code>
   module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="nibabel_apply_affine.html">
   Applying coordinate transforms with
   <code class="docutils literal notranslate">
    <span class="pre">
     nibabel.affines.apply_affine
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="map_coordinates.html">
   General resampling between images with
   <code class="docutils literal notranslate">
    <span class="pre">
     scipy.ndimage.map_coordinates
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="image_header_and_affine.html">
   The image header and affine
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Images and affines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rotation_2d_3d.html">
   Rotations and rotation matrices
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="resampling_with_ndimage.html">
   Resampling with
   <code class="docutils literal notranslate">
    <span class="pre">
     scipy.ndimage
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dipy_registration.html">
   Registration with dipy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="anterior_cingulate.html">
   Anterior cingulate
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  Statistics and the general linear model
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="mean_test_example.html">
   A worked example of the general linear model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hypothesis_tests.html">
   Hypothesis testing with the general linear model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="convolution_background.html">
   Convolving with the hemodyamic response function
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="model_one_voxel.html">
   Modeling a single voxel
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="test_one_voxel.html">
   Testing a single voxel
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="multi_multiply.html">
   Estimation for many voxels at the same time
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="non_tr_onsets.html">
   Using onsets that do not start on a TR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="whole_image_statistics.html">
   Whole-brain t tests and p values
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  Code organization and collaboration
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="on_modules.html">
   Modules and scripts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="path_manipulation.html">
   Making and breaking file paths in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sys_path.html">
   Where does Python look for modules?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assert.html">
   Using
   <code class="docutils literal notranslate">
    <span class="pre">
     assert
    </span>
   </code>
   for testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="coding_style.html">
   Python coding style
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/images_and_affines.Rmd"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.Rmd</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/nipraxis/textbook"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/nipraxis/textbook/issues/new?title=Issue%20on%20page%20%2Fimages_and_affines.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/nipraxis/textbook/main?urlpath=tree/images_and_affines.Rmd"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        <a class="jupyterhub-button" href="https://hub.nipraxis.org/hub/user-redirect/git-pull?repo=https://github.com/nipraxis/textbook&urlpath=tree/textbook/images_and_affines.Rmd&branch=main"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch JupyterHub" data-toggle="tooltip"
                data-placement="left"><img class="jupyterhub-button-logo"
                    src="_static/images/logo_jupyterhub.svg"
                    alt="Interact on JupyterHub">JupyterHub</button></a>
        
        
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Images and affines
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#affines-inverses">
     Affines, inverses
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#manipulating-affines-with-inverses">
   Manipulating affines with inverses
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <section id="images-and-affines">
<h1>Images and affines<a class="headerlink" href="#images-and-affines" title="Permalink to this headline">¶</a></h1>
<p>See: <a class="reference external" href="http://nipy.org/nibabel/coordinate_systems.html">coordinate systems and affine transforms</a> for background.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import common modules</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># print arrays to 4DP</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">npl</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
</pre></div>
</div>
</div>
</div>
<section id="affines-inverses">
<h2>Affines, inverses<a class="headerlink" href="#affines-inverses" title="Permalink to this headline">¶</a></h2>
<p>We often have the situation where we compose an affine of several transformations.
We do the composing using matrix multiplication.
For example, the following code composes two rotations and a translation.</p>
<div class="alert alert-info">
<p><strong>Remember:</strong>
Matrix multiplication works right to left.</p>
</div>
<p>Here is a rotation matrix (3 x 3) for a rotation of -0.2 radians around the x
axis:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">x_rotmat</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Rotation matrix for rotation of `theta` radians around x axis</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta : scalar</span>
<span class="sd">        Rotation angle in radians</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    M : shape (3, 3) array</span>
<span class="sd">        Rotation matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cos_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">sin_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">cos_t</span><span class="p">,</span> <span class="o">-</span><span class="n">sin_t</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">sin_t</span><span class="p">,</span> <span class="n">cos_t</span><span class="p">]])</span>

<span class="n">first_rotation</span> <span class="o">=</span> <span class="n">x_rotmat</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">first_rotation</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.    ,  0.    ,  0.    ],
       [ 0.    ,  0.9801,  0.1987],
       [ 0.    , -0.1987,  0.9801]])
</pre></div>
</div>
</div>
</div>
<p>We can make this rotation matrix into an affine transformation, by putting it
into the top left of a 4 x 4 identity matrix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">first_affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># The identity affine</span>
<span class="n">first_affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_rotation</span>
<span class="n">first_affine</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.    ,  0.    ,  0.    ,  0.    ],
       [ 0.    ,  0.9801,  0.1987,  0.    ],
       [ 0.    , -0.1987,  0.9801,  0.    ],
       [ 0.    ,  0.    ,  0.    ,  1.    ]])
</pre></div>
</div>
</div>
</div>
<p>Now we made a second affine matrix for a rotation around y of 0.4 radians:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">y_rotmat</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Rotation matrix for rotation of `theta` radians around y axis</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta : scalar</span>
<span class="sd">        Rotation angle in radians</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    M : shape (3, 3) array</span>
<span class="sd">        Rotation matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cos_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">sin_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cos_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sin_t</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="n">sin_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cos_t</span><span class="p">]])</span>

<span class="n">second_affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">second_affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_rotmat</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">second_affine</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.9211,  0.    ,  0.3894,  0.    ],
       [ 0.    ,  1.    ,  0.    ,  0.    ],
       [-0.3894,  0.    ,  0.9211,  0.    ],
       [ 0.    ,  0.    ,  0.    ,  1.    ]])
</pre></div>
</div>
</div>
</div>
<p>Finally we make a translation of 10 in x, 20 in y and 30 in z:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">third_affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">third_affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
<span class="n">third_affine</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.,  0.,  0., 10.],
       [ 0.,  1.,  0., 20.],
       [ 0.,  0.,  1., 30.],
       [ 0.,  0.,  0.,  1.]])
</pre></div>
</div>
</div>
</div>
<p>We compose these three affine matrices to give an affine implementing <em>first</em>
a rotation of -0.2 around the x axis, <em>then</em> a rotation of 0.4 around the y
axis, and <em>finally</em> a translation [10, 20, 30] in [x, y, z]. Note the order
– matrix multiplication goes from right to left:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">combined</span> <span class="o">=</span> <span class="n">third_affine</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">second_affine</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">first_affine</span><span class="p">))</span>
<span class="n">combined</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.9211, -0.0774,  0.3817, 10.    ],
       [ 0.    ,  0.9801,  0.1987, 20.    ],
       [-0.3894, -0.183 ,  0.9027, 30.    ],
       [ 0.    ,  0.    ,  0.    ,  1.    ]])
</pre></div>
</div>
</div>
</div>
<p>See The nibabel.affines module for a module with useful functions for working with
affine matrices.</p>
</section>
</section>
<section id="manipulating-affines-with-inverses">
<h1>Manipulating affines with inverses<a class="headerlink" href="#manipulating-affines-with-inverses" title="Permalink to this headline">¶</a></h1>
<p>Let us say we have an affine, like the one we just made:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">combined</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.9211, -0.0774,  0.3817, 10.    ],
       [ 0.    ,  0.9801,  0.1987, 20.    ],
       [-0.3894, -0.183 ,  0.9027, 30.    ],
       [ 0.    ,  0.    ,  0.    ,  1.    ]])
</pre></div>
</div>
</div>
</div>
<p>Imagine that we knew that this affine was composed of three affines, and we
knew the last two, but not the first. How would we find what the first affine
was?</p>
<p>Call our combined affine <span class="math notranslate nohighlight">\(\mathbf{D}\)</span>. We know that <span class="math notranslate nohighlight">\(\mathbf{D} =
\mathbf{C} \cdot \mathbf{B} \cdot \mathbf{A}\)</span>. We know <span class="math notranslate nohighlight">\(\mathbf{C}\)</span> and
<span class="math notranslate nohighlight">\(\mathbf{B}\)</span> but we want to find <span class="math notranslate nohighlight">\(\mathbf{A}\)</span>.</p>
<p>Above I’ve written matrix multiplication with a dot - as in <span class="math notranslate nohighlight">\(\mathbf{B}
\cdot \mathbf{A}\)</span>, but in what follows I’ll omit the dot, just writing
<span class="math notranslate nohighlight">\(\mathbf{B} \mathbf{A}\)</span> to mean matrix multiplication.</p>
<p>We find <span class="math notranslate nohighlight">\(\mathbf{A}\)</span> using matrix inverses. Call <span class="math notranslate nohighlight">\(\mathbf{E} =
\mathbf{C} \mathbf{B}\)</span>. Then <span class="math notranslate nohighlight">\(\mathbf{D} = \mathbf{E} \mathbf{A}\)</span>. If we
can find the inverse of <span class="math notranslate nohighlight">\(\mathbf{E}\)</span> (written as
<span class="math notranslate nohighlight">\(\mathbf{E^{-1}}\)</span>) then (by the definition of the inverse):</p>
<div class="math notranslate nohighlight">
\[
\mathbf{E^{-1}} \mathbf{E} = \mathbf{I}
\]</div>
<p>and:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{E^{-1}} \mathbf{D} = \mathbf{E^{-1}} \mathbf{E} \mathbf{A} \\
\mathbf{E^{-1}} \mathbf{D} = \mathbf{I} \mathbf{A} \\
\mathbf{E^{-1}} \mathbf{D} = \mathbf{A}
\end{split}\]</div>
<p>For reasons we do not have time to go into, our affine matrices are almost
invariably invertible.</p>
<p>Let’s see if we can reconstruct our <code class="docutils literal notranslate"><span class="pre">first_affine</span></code> from the <code class="docutils literal notranslate"><span class="pre">combined</span></code>
affine, given we know the <code class="docutils literal notranslate"><span class="pre">third_affine</span></code> and <code class="docutils literal notranslate"><span class="pre">second_affine</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">E</span> <span class="o">=</span> <span class="n">third_affine</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">second_affine</span><span class="p">)</span>
<span class="n">E_inv</span> <span class="o">=</span> <span class="n">npl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
<span class="n">E_inv</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.    ,  0.    , -0.    ,  0.    ],
       [ 0.    ,  0.9801,  0.1987,  0.    ],
       [-0.    , -0.1987,  0.9801,  0.    ],
       [ 0.    ,  0.    ,  0.    ,  1.    ]])
</pre></div>
</div>
</div>
</div>
<p>This is the same as our first affine:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">first_affine</span>
<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">E_inv</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">combined</span><span class="p">),</span> <span class="n">first_affine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>What about the situation where we know the first part of the affine, but we
want to find the rest?</p>
<p>To solve this problem, we will need the <em>right inverse</em>.</p>
<p>The inverse we have used so far is the <em>left inverse</em> - so called because we
apply it multiplying on the left of the original matrix:</p>
<div class="math notranslate nohighlight">
\[
\mathbf{E^{-1}} \mathbf{E} = \mathbf{I}
\]</div>
<p>Luckily, it turns out that, for square matrices, if there is a <em>left inverse</em>
<span class="math notranslate nohighlight">\(\mathbf{E^{-1}}\)</span> then this is also the right inverse:</p>
<div class="math notranslate nohighlight">
\[
\mathbf{E^{-1}} \mathbf{E} = \mathbf{E} \mathbf{E^{-1}} = \mathbf{I}
\]</div>
<p>It is a bit out of our way to prove that a matrix with a left inverse must
also have a right inverse.  If you accept that on faith for now, it is easy to
prove that, if there is a right inverse, it must be the same as the left
inverse. Call the left inverse <span class="math notranslate nohighlight">\(\mathbf{L}\)</span> and the right inverse
<span class="math notranslate nohighlight">\(\mathbf{R}\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{LA} = \mathbf{I}\\
\mathbf{AR} = \mathbf{I}\\
\end{split}\]</div>
<p>then:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{LAR} = \mathbf{LAR}\\
\mathbf{L(AR)} = \mathbf{(LA)R}\\
\mathbf{L} = \mathbf{R}
\end{split}\]</div>
<p>So, in our case, where we want to find the transformations <em>following</em> the
first affine, we can do this:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{F} \triangleq \mathbf{C} \mathbf{B} \\
\mathbf{D} = \mathbf{F} \mathbf{A} \\
\mathbf{D} \mathbf{A^{-1}} = \mathbf{F} \mathbf{A} \mathbf{A^{-1}} \\
\mathbf{D} \mathbf{A^{-1}} = \mathbf{F}
\end{split}\]</div>
<p>For our actual affines:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">third_with_second</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">npl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">first_affine</span><span class="p">))</span>
<span class="n">third_with_second</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.9211, -0.    ,  0.3894, 10.    ],
       [ 0.    ,  1.    , -0.    , 20.    ],
       [-0.3894, -0.    ,  0.9211, 30.    ],
       [ 0.    ,  0.    ,  0.    ,  1.    ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is the same as</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">third_affine</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">second_affine</span><span class="p">)</span>
<span class="n">F</span>  
<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">third_with_second</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "nipraxis/textbook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="image_header_and_affine.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">The image header and affine</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="rotation_2d_3d.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Rotations and rotation matrices</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The nipraxis team<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>